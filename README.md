# Engram

Persistent, tamper-evident memory for AI coding agents.

Engram is a small CLI that creates a hash-linked worklog inside your repository. Agents (or humans) write a short report in a draft file and then "commit" it into an append-only chain of entries that can be verified later.

## Description

- **Lives in the repo:** everything under `.engram/` (suitable for version control)
- **Low context overhead:** agents typically read only `.engram/draft.md` and `.engram/worklog/SUMMARY.md`
- **Tamper-evident:** each entry links to the previous entry's SHA256
- **Deterministic format:** stable headers and LF line endings to keep hashes reproducible

## How it works

After `engram init`, a project typically looks like:

```
project-root/
├── engram                  # POSIX wrapper (generated by `engram init`)
├── engram.cmd              # Windows wrapper (generated by `engram init`)
├── .engram/
│   ├── AGENTS.md           # Agent protocol (workflow + security rules)
│   ├── draft.md            # Mutable workspace (reset after commit)
│   ├── .gitignore          # Ignores downloaded binaries under .engram/bin/
│   ├── .gitattributes      # Forces LF under .engram/ for stable hashing
│   ├── bin/                # Download cache (ignored)
│   └── worklog/
│       ├── SUMMARY.md             # Index: filename | one-sentence summary
│       ├── 000001_a1b2c3d4.md     # First entry (Previous: none)
│       ├── 000002_e5f6a7b8.md     # Next entry (Previous: SHA256 of prior entry content)
│       └── ...
```

Each worklog entry includes stable headers:

- `Summary: ...`
- `Previous: none | <64-hex>`
- `Date: <UTC timestamp>`

The filename is `NNNNNN_HHHHHHHH.md` where `HHHHHHHH` is the first 8 hex chars of the SHA256 of the entry file content.

## Installation

### From GitHub Releases (recommended)

```bash
curl -fsSL https://raw.githubusercontent.com/lkubicek1/engram/main/install.sh | sh
```

Common options:

```bash
# Install a specific version
ENGRAM_VERSION=0.1.1 curl -fsSL https://raw.githubusercontent.com/lkubicek1/engram/main/install.sh | sh

# Install to a custom directory
INSTALL_DIR="$HOME/bin" curl -fsSL https://raw.githubusercontent.com/lkubicek1/engram/main/install.sh | sh
```

The installer downloads the appropriate release asset and verifies it against `checksums.txt` before installing.

Windows: download the `engram-windows-x86_64.exe` release asset (or build from source).

### From source

Requires Rust 2021 edition tooling.

```bash
git clone https://github.com/lkubicek1/engram.git
cd engram
cargo build --release
```

Binary output: `target/release/engram`.

## Usage

### Initialize a project

```bash
engram init
```

This creates `.engram/` plus per-repo wrapper scripts (`./engram` and `engram.cmd`).

Directive options (optional):

- `--warp` creates/appends `WARP.md`
- `--claude` creates/appends `CLAUDE.md`
- `--junie` creates/appends `.junie/guidelines.md`
- `--agents` creates/appends `AGENTS.md`
- `--all` applies all of the above

Commit `.engram/` and the wrapper scripts, but do not commit `.engram/bin/`.

### Write a draft and commit it

1. Edit `.engram/draft.md`.

Example:

```markdown
<summary>Added JWT authentication to the login endpoint</summary>

## Intent
The API needed stateless session management.

## Changes
- Created `src/auth/jwt.rs`
- Modified `src/routes/login.rs`

## Verification
- `cargo test` (all tests passing)
```

2. Commit:

```bash
engram commit
```

This validates the draft, writes a new entry under `.engram/worklog/`, appends to `.engram/worklog/SUMMARY.md`, and resets the draft.

### Verify the worklog

```bash
engram verify
```

Verifies the full hash chain and the filename/content-hash agreement.

### Check status

```bash
engram status
```

Shows entry count, latest entry summary, draft state, and chain verification.

## Rules for agents (and humans)

- Do not edit files in `.engram/worklog/` manually. Treat them as append-only.
- Do not manually calculate or enter hashes.
- Always use `engram commit` to write new entries.
- If you made a mistake in an old entry, add a new entry correcting it (editing history breaks the chain).

### Current limitation: single-writer, single-branch workflow

Engram’s current implementation is only stable when used as a **single linear workflow**:

- One active git branch updating `.engram/` at a time (avoid creating worklog entries on multiple branches and then merging them).
- One task/thread of work at a time.
- One agent (or human) editing `.engram/draft.md` and running `engram commit` at a time.

Not supported yet:

- Multi-agent workflows that write/commit concurrently to the same repo checkout.
- Concurrent `engram commit` runs (multiple terminals/processes).
- Merging divergent `.engram/worklog/` histories.

If you need multiple agents today, serialize them (one at a time) or keep separate clones/worklogs per agent and treat consolidation as a manual process.

## Sensitive data policy

Do not log secrets or sensitive data in any Engram documentation.

This includes passwords, API keys/tokens, credentials, private keys, connection strings with secrets, and PII.

Safe practice: reference secrets by name only (for example: "Rotated `PAYMENTS_API_KEY`") and keep values in your secret manager.

## Development (this repo)

CI runs the following, and local development should match:

```bash
cargo fmt -- --check
cargo clippy --all-targets -- -D warnings
cargo test
```

Repo layout (high level):

- `src/main.rs`: CLI definition + dispatch
- `src/commands/`: orchestration and filesystem I/O (`init`, `commit`, `verify`, `status`)
- `src/engram/`: parsing + formatting rules (draft, entry format, chain parsing)
- `src/templates/`: templates written by `init`/`commit` (draft/protocol/wrappers)
- `src/utils/`: hashing utilities

## License

MIT License — see [LICENSE](LICENSE) for details.
