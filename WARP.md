# WARP.md

Guidance for Warp when working on this repository (the Engram CLI).

## Common commands

### Build
```bash
# Debug build
cargo build

# Release build (binary at target/release/engram)
cargo build --release
```

### Run locally
```bash
# Run via cargo (recommended during development)
cargo run -- --help
cargo run -- init --help
cargo run -- init
cargo run -- init --warp
cargo run -- init --junie
cargo run -- init --agents
cargo run -- init --all
cargo run -- commit
cargo run -- verify
cargo run -- status

# Or run the built binary directly
./target/debug/engram --help
```

### Format / lint / test (match CI)
```bash
cargo fmt
cargo fmt -- --check
cargo clippy --all-targets -- -D warnings
cargo test
```

### Focused tests
```bash
# Single unit test (substring match)
cargo test test_parse_valid_draft

# Integration tests
cargo test --test integration_tests
cargo test --test integration_tests test_full_workflow

# Show println!/eprintln! output during tests
cargo test -- --nocapture
```

## Project shape (high level)

Engram is a single Rust binary crate (no separate `lib.rs`). The CLI is defined with `clap` derive macros in `src/main.rs` and dispatches into `src/commands/`.

## Key invariants (hashing + stability)

- **Worklog content is hashed.** The entry filename short-hash is derived from the entry file content, and each entry embeds the full SHA256 of the previous entry.
  - Any change to entry formatting/parsing must update both `commit`/`verify` and the tests.
- **Entry filenames must match** `NNNNNN_HHHHHHHH.md` (6-digit sequence + 8 lowercase hex chars).
- **Header lines are parsed by regex** and must remain stable in emitted entries:
  - `Summary: …`
  - `Previous: …`
  - `Date: …`
- **Line endings matter** for hashing. Engram writes `.engram/.gitattributes` to force LF under `.engram/`; avoid introducing platform-dependent formatting.
- **Directive-file idempotency** depends on the marker string `Engram Protocol`. If you change the directive templates, keep the marker so `init` can detect an existing directive and avoid duplication.
- **Distribution scripts must stay consistent**:
  - `install.sh` and the generated wrappers download release assets and verify `checksums.txt`.
  - Asset names/supported platforms are defined by `.github/workflows/release.yml`; keep the wrapper templates and `install.sh` in sync with it.

## Code map (where to change what)

- `src/main.rs`
  - CLI definition and dispatch.

- `src/commands/` (I/O + orchestration)
  - `init.rs`: creates `.engram/` scaffolding; writes wrapper scripts; optionally creates/appends root directive files.
  - `commit.rs`: reads `.engram/draft.md`, writes a new entry under `.engram/worklog/`, appends to `.engram/worklog/SUMMARY.md`, then resets the draft.
  - `verify.rs`: validates the hash chain and filename/content-hash agreement; uses explicit exit codes.
  - `status.rs`: summarizes current `.engram` state and runs verification.

- `src/engram/` (format parsing + domain rules)
  - `draft.rs`: parses `<summary>…</summary>` and validates the body has non-comment content.
  - `worklog.rs`: structures + string formatting for entries; parses filenames.
  - `chain.rs`: parsers for `Previous:` / `Summary:` / `Date:` lines.
  - `summary.rs`: appends rows to `.engram/worklog/SUMMARY.md`.

- `src/templates/` (string constants written by `init` / `commit`)
  - `draft.rs`, `agents.rs`, `summary.rs`, `directive.rs`, `wrapper_sh.rs`, `wrapper_cmd.rs`.
  - If you change any template constants, update tests that assert on their contents.

- `src/utils/`
  - `hash.rs`: SHA256 helpers (`sha256_hex`, `sha256_short`).

## Tests (how they execute)

- Unit tests are colocated with modules (`#[cfg(test)]` in `src/**.rs`).
- Integration tests live in `tests/integration_tests.rs` and execute the built `engram` binary by locating it via `std::env::current_exe()`.
  - If you change CLI output strings or exit codes, update integration tests accordingly.

## Release automation (distribution)

- Tag pushes matching `v*` trigger `.github/workflows/release.yml`, producing per-platform assets plus `checksums.txt`.
- The wrapper scripts generated by `init` embed the crate version and expect release tags and asset naming to follow that workflow.

## Canonical directory name

Engram uses `.engram/worklog/` as the canonical on-disk directory name.
